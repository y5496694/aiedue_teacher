<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì´ë‘ í‹°ì³ AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .generated-content h2 { font-size: 1.5rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid #E5E7EB; }
        .generated-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; }
        .generated-content p { margin-bottom: 1rem; line-height: 1.75; }
        .generated-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        .generated-content li { margin-bottom: 0.5rem; }
        .generated-content table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .generated-content th, .generated-content td { border: 1px solid #D1D5DB; padding: 0.75rem; text-align: left; }
        .generated-content th { background-color: #F9FAFB; font-weight: 600; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #7A9D54; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #7A9D54; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-[#7A9D54] mb-6">ì—ì´ë‘ í‹°ì³ AI ì‹œì‘í•˜ê¸°</h2>
                <form id="auth-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">ì´ë©”ì¼</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <div class="flex items-center justify-between">
                        <button type="button" id="login-btn" class="bg-[#7A9D54] hover:bg-[#6a8a4a] text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">ë¡œê·¸ì¸</button>
                        <button type="button" id="signup-btn" class="inline-block align-baseline font-bold text-sm text-green-600 hover:text-green-800">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</button>
                    </div>
                    <div class="my-4 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">ë˜ëŠ”</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <button type="button" id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-[#7A9D54]">ğŸ“ ì—ì´ë‘ í‹°ì³ AI</h1>
                    <nav class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <a href="#dashboard" id="nav-dashboard" class="nav-link">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="#generator" id="nav-generator" class="nav-link">ê³„íšì„œ ìƒì„±</a>
                        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-6">
                <!-- Dashboard View -->
                <div id="dashboard-view">
                    <h2 class="text-3xl font-bold mb-6">ëŒ€ì‹œë³´ë“œ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-2">ì•ˆë…•í•˜ì„¸ìš”, <span id="dashboard-user-email"></span> ì„ ìƒë‹˜!</h3>
                            <p class="text-gray-600 mb-4">ì—ì´ë‘ í‹°ì³ AIì™€ í•¨ê»˜ë¼ë©´ í•™êµ ìš´ì˜ê³„íšì„œ ì‘ì„±ì´ ì‰¬ì›Œì§‘ë‹ˆë‹¤.</p>
                            <button id="go-to-generator-btn" class="bg-[#7A9D54] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#6a8a4a] transition-colors">ìƒˆ ìš´ì˜ê³„íšì„œ ë§Œë“¤ê¸° â†’</button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">ìƒì„± í†µê³„</h3>
                            <div id="stats-chart-container" class="h-48 flex items-center justify-center">
                                <canvas id="statsChart"></canvas>
                            </div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">ìµœê·¼ ìƒì„±í•œ ê³„íšì„œ</h3>
                            <div id="recent-plans-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
                <!-- Generator View -->
                <div id="generator-view" class="hidden">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h2 class="text-xl font-bold mb-4 border-b pb-2">1. ê³„íšì„œ ì¡°ê±´ ì…ë ¥</h2>
                            <form id="plan-form" class="space-y-4" onsubmit="return false;">
                                <div>
                                    <label for="school-level" class="block text-sm font-medium text-gray-700">í•™êµê¸‰</label>
                                    <select id="school-level" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 sm:text-sm"></select>
                                </div>
                                <div>
                                    <label for="plan-type" class="block text-sm font-medium text-gray-700">ê³„íšì„œ ì¢…ë¥˜</label>
                                    <select id="plan-type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 sm:text-sm"></select>
                                </div>
                                <div id="custom-plan-type-wrapper" class="hidden">
                                    <label for="custom-plan-type" class="block text-sm font-medium text-gray-700">ê³„íšì„œ ì¢…ë¥˜ ì§ì ‘ ì…ë ¥</label>
                                    <input type="text" id="custom-plan-type" placeholder="ì˜ˆ: ê°€ì„ í˜„ì¥ì²´í—˜í•™ìŠµ ê³„íš" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="keywords" class="block text-sm font-medium text-gray-700">í•µì‹¬ í‚¤ì›Œë“œ (ì„ íƒ)</label>
                                    <input type="text" id="keywords" placeholder="ì˜ˆ: ë©”íƒ€ë²„ìŠ¤, AI ìœµí•©, í•™ìƒ ì£¼ë„" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm">
                                </div>
                                <div class="flex items-center"><input type="checkbox" id="include-budget" class="mr-2"><label for="include-budget" class="text-sm font-medium text-gray-700">ì˜ˆì‚° í¬í•¨</label></div>
                                <p id="form-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                                <button type="submit" id="generate-btn" class="w-full bg-[#7A9D54] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#6a8a4a] flex items-center justify-center">AI ìš´ì˜ê³„íšì„œ ìƒì„±</button>
                            </form>
                        </aside>
                        <section id="output-panel" class="w-full lg:w-2/3 bg-white p-8 rounded-lg shadow-lg">
                            <div id="initial-message"><h2 class="text-2xl font-bold text-gray-800">AI ìš´ì˜ê³„íšì„œ ì´ˆì•ˆì´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</h2></div>
                            <div id="loading-indicator" class="hidden flex-col items-center justify-center text-center"><div class="loader"></div><p class="mt-4 text-lg font-semibold text-gray-700">AIê°€ ì—´ì‹¬íˆ ê³„íšì„œë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p></div>
                            <div id="generated-content-wrapper" class="hidden">
                                <div class="flex justify-between items-center border-b pb-2 mb-4">
                                    <h2 id="plan-title" class="text-2xl font-bold"></h2>
                                    <button id="copy-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">ë³¸ë¬¸ ë³µì‚¬</button>
                                </div>
                                <div id="generated-content" class="generated-content"></div>
                            </div>
                            <div id="error-message" class="hidden text-center"><h2 class="text-2xl font-bold text-red-600">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h2><p id="error-details" class="mt-4 text-gray-600"></p></div>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
          getAuth,
          createUserWithEmailAndPassword,
          signInWithEmailAndPassword,
          onAuthStateChanged,
          signOut,
          GoogleAuthProvider,
          signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
          getFirestore,
          collection,
          addDoc,
          query,
          getDocs,
          doc,
          getDoc,
          deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Firebase config (ë³¸ì¸ í”„ë¡œì íŠ¸ ì •ë³´ë¡œ êµì²´)
        const firebaseConfig = {
          apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
          authDomain: "mansungcoin-c6e06.firebaseapp.com",
          databaseURL: "https://mansungcoin-c6e06-default-rtdb.firebaseio.com",
          projectId: "mansungcoin-c6e06",
          storageBucket: "mansungcoin-c6e06.appspot.com",
          messagingSenderId: "704809284946",
          appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };
        
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOM ìš”ì†Œ
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        const dashboardUserEmailSpan = document.getElementById('dashboard-user-email');
        const navDashboard = document.getElementById('nav-dashboard');
        const navGenerator = document.getElementById('nav-generator');
        const dashboardView = document.getElementById('dashboard-view');
        const generatorView = document.getElementById('generator-view');
        const goToGeneratorBtn = document.getElementById('go-to-generator-btn');
        const recentPlansList = document.getElementById('recent-plans-list');
        const form = document.getElementById('plan-form');
        const generateBtn = document.getElementById('generate-btn');
        const initialMessage = document.getElementById('initial-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const generatedContentWrapper = document.getElementById('generated-content-wrapper');
        const generatedContentDiv = document.getElementById('generated-content');
        const planTitle = document.getElementById('plan-title');
        const errorMessageDiv = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const copyBtn = document.getElementById('copy-btn');
        const outputPanel = document.getElementById('output-panel');
        const schoolLevelSelect = document.getElementById('school-level');
        const planTypeSelect = document.getElementById('plan-type');
        const customPlanTypeWrapper = document.getElementById('custom-plan-type-wrapper');
        const customPlanTypeInput = document.getElementById('custom-plan-type');
        const formError = document.getElementById('form-error');
        const includeBudgetCheckbox = document.getElementById('include-budget');
        
        let statsChartInstance = null;
        
        // -------------------------
        // ì¸ì¦ ê´€ë ¨ ì²˜ë¦¬
        // -------------------------
        onAuthStateChanged(auth, user => {
          if (user) {
            authView.classList.add('hidden');
            mainAppView.classList.remove('hidden');
            mainAppView.classList.add('flex');
            const userEmail = user.displayName || user.email;
            userEmailSpan.textContent = userEmail;
            dashboardUserEmailSpan.textContent = userEmail;
            switchView(window.location.hash.substring(1) || 'dashboard');
            loadAndDisplayPlans();
          } else {
            authView.classList.remove('hidden');
            mainAppView.classList.add('hidden');
            mainAppView.classList.remove('flex');
          }
        });
        
        const handleAuthError = (error) => {
          console.error("Authentication Error:", error);
          let errorMessage = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
          switch (error.code) {
            case 'auth/invalid-email':
              errorMessage = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.';
              break;
            case 'auth/user-not-found':
            case 'auth/invalid-credential':
              errorMessage = 'ê°€ì…ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì´ê±°ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
              break;
            case 'auth/wrong-password':
              errorMessage = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
              break;
            case 'auth/email-already-in-use':
              errorMessage = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
              break;
            case 'auth/weak-password':
              errorMessage = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
              break;
            case 'auth/popup-closed-by-user':
              errorMessage = 'ë¡œê·¸ì¸ íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.';
              break;
            case 'auth/unauthorized-domain':
              errorMessage = "ë¡œê·¸ì¸ì´ í—ˆìš©ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì…ë‹ˆë‹¤. Firebase ì½˜ì†” > Authentication > ì„¤ì • > ìŠ¹ì¸ëœ ë„ë©”ì¸ì— 'googleusercontent.com'ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.";
              break;
            case 'auth/identity-toolkit-api-has-not-been-used-in-project':
              errorMessage = "Firebase í”„ë¡œì íŠ¸ì˜ ì¸ì¦ APIê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Google Cloud ì½˜ì†”ì—ì„œ 'Identity Toolkit API'ë¥¼ í™œì„±í™”í•´ì£¼ì„¸ìš”.";
              break;
            default:
              errorMessage = `ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${error.code})`;
              break;
          }
          authError.textContent = errorMessage;
          authError.classList.remove('hidden');
        };
        
        signupBtn.addEventListener('click', async () => {
          authError.classList.add('hidden');
          try {
            await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
          } catch (error) {
            handleAuthError(error);
          }
        });
        
        loginBtn.addEventListener('click', async () => {
          authError.classList.add('hidden');
          try {
            await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
          } catch (error) {
            handleAuthError(error);
          }
        });
        
        googleLoginBtn.addEventListener('click', async () => {
          authError.classList.add('hidden');
          const provider = new GoogleAuthProvider();
          try {
            await signInWithPopup(auth, provider);
          } catch (error) {
            handleAuthError(error);
          }
        });
        
        logoutBtn.addEventListener('click', () => signOut(auth));
        
        // -------------------------
        // ë·° ì „í™˜ ê´€ë ¨ ì²˜ë¦¬
        // -------------------------
        const switchView = (view) => {
          const targetView = view || 'dashboard';
          dashboardView.classList.toggle('hidden', targetView !== 'dashboard');
          generatorView.classList.toggle('hidden', targetView !== 'generator');
          navDashboard.classList.toggle('active', targetView === 'dashboard');
          navGenerator.classList.toggle('active', targetView === 'generator');
          window.location.hash = targetView;
          if (targetView === 'dashboard') {
            loadAndDisplayPlans();
          }
        };
        
        navDashboard.addEventListener('click', (e) => {
          e.preventDefault();
          switchView('dashboard');
        });
        navGenerator.addEventListener('click', (e) => {
          e.preventDefault();
          switchView('generator');
        });
        goToGeneratorBtn.addEventListener('click', () => switchView('generator'));
        
        // -------------------------
        // í†µê³„ ì°¨íŠ¸ ë Œë”ë§
        // -------------------------
        const updateStatsChart = (plans) => {
          const statsCanvas = document.getElementById('statsChart');
          const chartContainer = document.getElementById('stats-chart-container');
          const ctx = statsCanvas.getContext('2d');
        
          if (statsChartInstance) {
            statsChartInstance.destroy();
            statsChartInstance = null;
          }
      
          const existingMessage = chartContainer.querySelector('.no-data-message');
          if (existingMessage) existingMessage.remove();
          statsCanvas.style.display = 'block';
      
          if (!plans || plans.length === 0) {
            statsCanvas.style.display = 'none';
            const noDataMessage = document.createElement('div');
            noDataMessage.className = 'no-data-message text-center text-gray-500 flex items-center justify-center h-full';
            noDataMessage.textContent = 'ìƒì„±ëœ ê³„íšì„œ ì—†ìŒ';
            chartContainer.appendChild(noDataMessage);
            return;
          }
      
          const standardTypes = [
            'í•™êµí­ë ¥ ì˜ˆë°© êµìœ¡ ê³„íš',
            'ì§„ë¡œ ì²´í—˜ í™œë™ ê³„íš',
            'ë””ì§€í„¸ ë¦¬í„°ëŸ¬ì‹œ êµìœ¡ ê³„íš',
            'ê¸°ì´ˆí•™ë ¥ í–¥ìƒ ì§€ì› ê³„íš',
            'ë‹¤ë¬¸í™” êµìœ¡ í™œë™ ê³„íš'
          ];
          const stats = { ê¸°íƒ€: 0 };
          standardTypes.forEach(t => stats[t] = 0);
      
          plans.forEach(plan => {
            if (standardTypes.includes(plan.planType)) {
              stats[plan.planType]++;
            } else {
              stats['ê¸°íƒ€']++;
            }
          });
      
          const chartData = Object.values(stats).filter(count => count > 0);
          const chartLabels = Object.keys(stats).filter(type => stats[type] > 0);
      
          const shortLabels = chartLabels.map(label => {
            if (label === 'ê¸°íƒ€') return 'ê¸°íƒ€';
            return label.split(' ')[0];
          });
      
          statsChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: shortLabels,
              datasets: [{
                label: 'ê³„íšì„œ ì¢…ë¥˜',
                data: chartData,
                backgroundColor: ['#7A9D54', '#A8C292', '#E0A75E', '#F1DDBF', '#D4A5A5', '#8B9A46'],
                hoverOffset: 4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: { padding: 15, font: { family: "'Noto Sans KR', sans-serif" } }
                }
              }
            }
          });
        };
        
        // -------------------------
        // Firestore ë¡œë“œ ë° UI ë Œë”ë§
        // -------------------------
        const loadAndDisplayPlans = async () => {
          const user = auth.currentUser;
          if (!user) return;
        
          const plansCollectionRef = collection(db, "users", user.uid, "plans");
          const q = query(plansCollectionRef);
        
          try {
            const querySnapshot = await getDocs(q);
            const plans = [];
            querySnapshot.forEach(doc => {
              plans.push({ id: doc.id, ...doc.data() });
            });
        
            plans.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
        
            updateStatsChart(plans);
        
            recentPlansList.innerHTML = '';
            if (plans.length === 0) {
              recentPlansList.innerHTML = `<p class="text-gray-500 text-center py-4">ì•„ì§ ìƒì„±ëœ ê³„íšì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
              return;
            }
        
            const recent5Plans = plans.slice(0, 5);
            recent5Plans.forEach(plan => {
              const planElement = document.createElement('div');
              planElement.className = 'p-4 border rounded-md hover:bg-gray-50 transition-colors flex justify-between items-center';
              planElement.innerHTML = `
                <div>
                  <p class="font-semibold">${plan.title || '(ì œëª©ì—†ìŒ)'}</p>
                  <p class="text-sm text-gray-500">ìƒì„±ì¼: ${plan.createdAt ? new Date(plan.createdAt.toDate()).toLocaleDateString() : '-'}</p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="view-plan-btn text-sm font-medium text-blue-600 hover:underline" data-id="${plan.id}">ë³´ê¸°</button>
                  <button class="delete-plan-btn text-sm font-medium text-red-600 hover:underline" data-id="${plan.id}">ì‚­ì œ</button>
                </div>
              `;
              recentPlansList.appendChild(planElement);
            });
        
            // â€˜ë³´ê¸°â€™ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
            document.querySelectorAll('.view-plan-btn').forEach(button => {
              button.onclick = async e => {
                const user = auth.currentUser;
                if (!user) return;
                const id = e.target.dataset.id;
                try {
                  const docRef = doc(db, "users", user.uid, "plans", id);
                  const docSnap = await getDoc(docRef);
                  if (docSnap.exists()) {
                    const plan = docSnap.data();
                    switchView('generator');
                    displayContent(plan.rawContent, plan.title);
                    outputPanel.scrollIntoView({ behavior: 'smooth' });
                  } else {
                    alert('ê³„íšì„œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                  }
                } catch (error) {
                  console.error('Error loading plan:', error);
                  alert('ê³„íšì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
              };
            });
        
            // â€˜ì‚­ì œâ€™ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
            document.querySelectorAll('.delete-plan-btn').forEach(button => {
              button.onclick = async e => {
                const user = auth.currentUser;
                if (!user) return;
                if (!confirm('í•´ë‹¹ ê³„íšì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                const id = e.target.dataset.id;
                try {
                  await deleteDoc(doc(db, "users", user.uid, "plans", id));
                  await loadAndDisplayPlans();
                } catch (error) {
                  console.error('Error deleting plan:', error);
                  alert('ê³„íšì„œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
              };
            });
        
          } catch (error) {
            console.error("Error loading plans:", error);
            recentPlansList.innerHTML = `<p class="text-red-500 text-center py-4">ê³„íšì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</p>`;
            updateStatsChart([]);
          }
        };
        
        // -------------------------
        // ê³„íšì„œ ì¡°ê±´ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì´ˆê¸°í™”
        // -------------------------
        const populateSelects = () => {
          const schoolLevels = ['ì´ˆë“±í•™êµ', 'ì¤‘í•™êµ', 'ê³ ë“±í•™êµ'];
          const planTypes = [
            'í•™êµí­ë ¥ ì˜ˆë°© êµìœ¡ ê³„íš',
            'ì§„ë¡œ ì²´í—˜ í™œë™ ê³„íš',
            'ë””ì§€í„¸ ë¦¬í„°ëŸ¬ì‹œ êµìœ¡ ê³„íš',
            'ê¸°ì´ˆí•™ë ¥ í–¥ìƒ ì§€ì› ê³„íš',
            'ë‹¤ë¬¸í™” êµìœ¡ í™œë™ ê³„íš',
            'ì§ì ‘ ì…ë ¥'
          ];
        
          schoolLevelSelect.innerHTML = schoolLevels.map(level => `<option value="${level}">${level}</option>`).join('');
          planTypeSelect.innerHTML = planTypes.map(type => `<option value="${type === 'ì§ì ‘ ì…ë ¥' ? 'custom' : type}">${type}</option>`).join('');
        };
        
        planTypeSelect.addEventListener('change', () => {
          customPlanTypeWrapper.classList.toggle('hidden', planTypeSelect.value !== 'custom');
        });
        
        // -------------------------
        // AI ìš´ì˜ê³„íšì„œ ìƒì„± (ë°±ì—”ë“œ í˜¸ì¶œ)
        // -------------------------
        form.addEventListener('submit', async e => {
          e.preventDefault();
          const user = auth.currentUser;
          if (!user) {
            formError.textContent = 'ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
            formError.classList.remove('hidden');
            return;
          }
          formError.classList.add('hidden');
      
          let planType = planTypeSelect.value;
          if (planType === 'custom') {
            planType = customPlanTypeInput.value.trim();
            if (!planType) {
              formError.textContent = 'ê³„íšì„œ ì¢…ë¥˜ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
              formError.classList.remove('hidden');
              return;
            }
          }
      
          initialMessage.classList.add('hidden');
          generatedContentWrapper.classList.add('hidden');
          errorMessageDiv.classList.add('hidden');
          loadingIndicator.style.display = 'flex';
          generateBtn.disabled = true;
          generateBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span class="ml-2">ìƒì„± ì¤‘...</span>`;
      
          try {
            const keywords = document.getElementById('keywords').value || 'ì—†ìŒ';
            const includeBudget = includeBudgetCheckbox.checked;
        
            // Firebase ID í† í° ë°œê¸‰ (ë°±ì—”ë“œ ì¸ì¦ìš©)
            const idToken = await user.getIdToken();
        
            const requestBody = {
              token: idToken,
              schoolLevel: schoolLevelSelect.value,
              planType,
              keywords,
              includeBudget,
            };
        
            // ë°˜ë“œì‹œ ë°°í¬ ë§ê²Œ ìˆ˜ì • í•„ìš”
            const backendUrl = 'http://localhost:8080/generatePlan';
        
            const response = await fetch(backendUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestBody),
            });
        
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || 'AI ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        
            const data = await response.json();
            const rawText = data.planText;
        
            const finalTitle = displayContent(rawText, planType);
        
            // Firestore ì €ì¥ì€ ë°±ì—”ë“œì—ì„œ í•˜ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ ìª½ ì¶”ê°€ ì €ì¥ ì½”ë“œ ì—†ìŒ
        
            outputPanel.scrollIntoView({ behavior: 'smooth' });
        
            // ìƒì„± í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadAndDisplayPlans();
        
          } catch (error) {
            console.error('AI ìƒì„± ì˜¤ë¥˜:', error);
            errorMessageDiv.classList.remove('hidden');
            errorDetails.textContent = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          } finally {
            loadingIndicator.style.display = 'none';
            generateBtn.disabled = false;
            generateBtn.innerHTML = `<span>AI ìš´ì˜ê³„íšì„œ ìƒì„±</span>`;
          }
        });
        
        // -------------------------
        // AI ê²°ê³¼ ë‚´ìš© ì¶œë ¥ í•¨ìˆ˜
        // -------------------------
        function displayContent(rawText, defaultTitle) {
          const lines = rawText.split('\n');
          let html = '';
          let title = defaultTitle;
          let inTable = false;
        
          lines.forEach(line => {
            line = line.trim();
            if (line.startsWith('TITLE:')) {
              title = line.replace('TITLE:', '').trim();
              return;
            }
            if (inTable && !line.includes('|')) {
              html += '</tbody></table>';
              inTable = false;
            }
            if (line.startsWith('### ')) {
              html += `<h2>${line.replace('### ', '')}</h2>`;
            } else if (line.startsWith('* ')) {
              html += `<ul><li>${line.replace('* ', '')}</li></ul>`;
            } else if (line.includes('|')) {
              if (!inTable) {
                html += '<table class="w-full border-collapse"><thead><tr class="bg-gray-100">';
                const headers = line.split('|').map(h => h.trim()).filter(Boolean);
                headers.forEach(header => html += `<th class="border p-2">${header}</th>`);
                html += '</tr></thead><tbody>';
                inTable = true;
              } else if (!line.includes('---')) {
                html += '<tr>';
                const cells = line.split('|').map(c => c.trim()).filter(Boolean);
                cells.forEach(cell => html += `<td class="border p-2">${cell}</td>`);
                html += '</tr>';
              }
            } else if (line) {
              html += `<p>${line}</p>`;
            }
          });
      
          if (inTable) {
            html += '</tbody></table>';
          }
      
          planTitle.textContent = title;
          generatedContentDiv.innerHTML = html.replace(/<\/ul>\s*<ul>/g, '');
          generatedContentWrapper.classList.remove('hidden');
          initialMessage.classList.add('hidden');
          return title;
        }
        
        // -------------------------
        // ê²°ê³¼ ë³µì‚¬ ê¸°ëŠ¥
        // -------------------------
        copyBtn.addEventListener('click', async () => {
          const htmlContent = generatedContentDiv.innerHTML;
        
          try {
            if (navigator.clipboard && window.ClipboardItem) {
              await navigator.clipboard.write([
                new ClipboardItem({ 'text/html': new Blob([htmlContent], { type: 'text/html' }) })
              ]);
            } else {
              const textArea = document.createElement('textarea');
              textArea.value = htmlContent;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
            }
            copyBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ!';
          } catch (err) {
            console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
            copyBtn.textContent = 'ë³µì‚¬ ì‹¤íŒ¨';
          }
          setTimeout(() => { copyBtn.textContent = 'ë³¸ë¬¸ ë³µì‚¬'; }, 2000);
        });
        
        // -------------------------
        // ì´ˆê¸°í™”
        // -------------------------
        populateSelects();

    </script>
</body>
</html>
