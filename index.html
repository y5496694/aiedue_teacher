<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에이두 티쳐 AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .generated-content h2 { font-size: 1.5rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid #E5E7EB; }
        .generated-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; }
        .generated-content p { margin-bottom: 1rem; line-height: 1.75; }
        .generated-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        .generated-content li { margin-bottom: 0.5rem; }
        .generated-content table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .generated-content th, .generated-content td { border: 1px solid #D1D5DB; padding: 0.75rem; text-align: left; }
        .generated-content th { background-color: #F9FAFB; font-weight: 600; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #7A9D54; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #7A9D54; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-[#7A9D54] mb-6">에이두 티쳐 AI 시작하기</h2>
                <form id="auth-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">이메일</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <div class="flex items-center justify-between">
                        <button type="button" id="login-btn" class="bg-[#7A9D54] hover:bg-[#6a8a4a] text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">로그인</button>
                        <button type="button" id="signup-btn" class="inline-block align-baseline font-bold text-sm text-green-600 hover:text-green-800">계정이 없으신가요? 회원가입</button>
                    </div>
                    <div class="my-4 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">또는</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <button type="button" id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Google 계정으로 로그인
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-[#7A9D54]">📝 에이두 티쳐 AI</h1>
                    <nav class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <a href="#dashboard" id="nav-dashboard" class="nav-link">대시보드</a>
                        <a href="#generator" id="nav-generator" class="nav-link">계획서 생성</a>
                        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">로그아웃</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-6">
                <!-- Dashboard View -->
                <div id="dashboard-view">
                    <h2 class="text-3xl font-bold mb-6">대시보드</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-2">안녕하세요, <span id="dashboard-user-email"></span> 선생님!</h3>
                            <p class="text-gray-600 mb-4">에이두 티쳐 AI와 함께라면 학교 운영계획서 작성이 쉬워집니다.</p>
                            <button id="go-to-generator-btn" class="bg-[#7A9D54] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#6a8a4a] transition-colors">새 운영계획서 만들기 →</button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">생성 통계</h3>
                            <div id="stats-chart-container" class="h-48 flex items-center justify-center">
                                <canvas id="statsChart"></canvas>
                            </div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">최근 생성한 계획서</h3>
                            <div id="recent-plans-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
                <!-- Generator View -->
                <div id="generator-view" class="hidden">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h2 class="text-xl font-bold mb-4 border-b pb-2">1. 계획서 조건 입력</h2>
                            <form id="plan-form" class="space-y-4" onsubmit="return false;">
                                <div>
                                    <label for="school-level" class="block text-sm font-medium text-gray-700">학교급</label>
                                    <select id="school-level" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 sm:text-sm"></select>
                                </div>
                                <div>
                                    <label for="plan-type" class="block text-sm font-medium text-gray-700">계획서 종류</label>
                                    <select id="plan-type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 sm:text-sm"></select>
                                </div>
                                <div id="custom-plan-type-wrapper" class="hidden">
                                    <label for="custom-plan-type" class="block text-sm font-medium text-gray-700">계획서 종류 직접 입력</label>
                                    <input type="text" id="custom-plan-type" placeholder="예: 가을 현장체험학습 계획" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="keywords" class="block text-sm font-medium text-gray-700">핵심 키워드 (선택)</label>
                                    <input type="text" id="keywords" placeholder="예: 메타버스, AI 융합, 학생 주도" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm">
                                </div>
                                <div class="flex items-center"><input type="checkbox" id="include-budget" class="mr-2"><label for="include-budget" class="text-sm font-medium text-gray-700">예산 포함</label></div>
                                <p id="form-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                                <button type="submit" id="generate-btn" class="w-full bg-[#7A9D54] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#6a8a4a] flex items-center justify-center">AI 운영계획서 생성</button>
                            </form>
                        </aside>
                        <section id="output-panel" class="w-full lg:w-2/3 bg-white p-8 rounded-lg shadow-lg">
                            <div id="initial-message"><h2 class="text-2xl font-bold text-gray-800">AI 운영계획서 초안이 이곳에 표시됩니다.</h2></div>
                            <div id="loading-indicator" class="hidden flex-col items-center justify-center text-center"><div class="loader"></div><p class="mt-4 text-lg font-semibold text-gray-700">AI가 열심히 계획서를 작성하고 있습니다...</p></div>
                            <div id="generated-content-wrapper" class="hidden">
                                <div class="flex justify-between items-center border-b pb-2 mb-4">
                                    <h2 id="plan-title" class="text-2xl font-bold"></h2>
                                    <button id="copy-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">본문 복사</button>
                                </div>
                                <div id="generated-content" class="generated-content"></div>
                            </div>
                            <div id="error-message" class="hidden text-center"><h2 class="text-2xl font-bold text-red-600">오류가 발생했습니다</h2><p id="error-details" class="mt-4 text-gray-600"></p></div>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
          getAuth,
          createUserWithEmailAndPassword,
          signInWithEmailAndPassword,
          onAuthStateChanged,
          signOut,
          GoogleAuthProvider,
          signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
          getFirestore,
          collection,
          addDoc,
          query,
          getDocs,
          doc,
          getDoc,
          deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Firebase config (본인 프로젝트 정보로 교체)
        const firebaseConfig = {
          apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
          authDomain: "mansungcoin-c6e06.firebaseapp.com",
          databaseURL: "https://mansungcoin-c6e06-default-rtdb.firebaseio.com",
          projectId: "mansungcoin-c6e06",
          storageBucket: "mansungcoin-c6e06.appspot.com",
          messagingSenderId: "704809284946",
          appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };
        
        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOM 요소
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        const dashboardUserEmailSpan = document.getElementById('dashboard-user-email');
        const navDashboard = document.getElementById('nav-dashboard');
        const navGenerator = document.getElementById('nav-generator');
        const dashboardView = document.getElementById('dashboard-view');
        const generatorView = document.getElementById('generator-view');
        const goToGeneratorBtn = document.getElementById('go-to-generator-btn');
        const recentPlansList = document.getElementById('recent-plans-list');
        const form = document.getElementById('plan-form');
        const generateBtn = document.getElementById('generate-btn');
        const initialMessage = document.getElementById('initial-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const generatedContentWrapper = document.getElementById('generated-content-wrapper');
        const generatedContentDiv = document.getElementById('generated-content');
        const planTitle = document.getElementById('plan-title');
        const errorMessageDiv = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const copyBtn = document.getElementById('copy-btn');
        const outputPanel = document.getElementById('output-panel');
        const schoolLevelSelect = document.getElementById('school-level');
        const planTypeSelect = document.getElementById('plan-type');
        const customPlanTypeWrapper = document.getElementById('custom-plan-type-wrapper');
        const customPlanTypeInput = document.getElementById('custom-plan-type');
        const formError = document.getElementById('form-error');
        const includeBudgetCheckbox = document.getElementById('include-budget');
        
        let statsChartInstance = null;
        
        // -------------------------
        // 인증 관련 처리
        // -------------------------
        onAuthStateChanged(auth, user => {
          if (user) {
            authView.classList.add('hidden');
            mainAppView.classList.remove('hidden');
            mainAppView.classList.add('flex');
            const userEmail = user.displayName || user.email;
            userEmailSpan.textContent = userEmail;
            dashboardUserEmailSpan.textContent = userEmail;
            switchView(window.location.hash.substring(1) || 'dashboard');
            loadAndDisplayPlans();
          } else {
            authView.classList.remove('hidden');
            mainAppView.classList.add('hidden');
            mainAppView.classList.remove('flex');
          }
        });
        
        const handleAuthError = (error) => {
          console.error("Authentication Error:", error);
          let errorMessage = "오류가 발생했습니다. 다시 시도해주세요.";
          switch (error.code) {
            case 'auth/invalid-email':
              errorMessage = '유효하지 않은 이메일 주소입니다.';
              break;
            case 'auth/user-not-found':
            case 'auth/invalid-credential':
              errorMessage = '가입되지 않은 이메일이거나 비밀번호가 틀렸습니다.';
              break;
            case 'auth/wrong-password':
              errorMessage = '비밀번호가 틀렸습니다.';
              break;
            case 'auth/email-already-in-use':
              errorMessage = '이미 사용 중인 이메일입니다.';
              break;
            case 'auth/weak-password':
              errorMessage = '비밀번호는 6자 이상이어야 합니다.';
              break;
            case 'auth/popup-closed-by-user':
              errorMessage = '로그인 팝업이 닫혔습니다.';
              break;
            case 'auth/unauthorized-domain':
              errorMessage = "로그인이 허용되지 않은 도메인입니다. Firebase 콘솔 > Authentication > 설정 > 승인된 도메인에 'googleusercontent.com'을 추가해주세요.";
              break;
            case 'auth/identity-toolkit-api-has-not-been-used-in-project':
              errorMessage = "Firebase 프로젝트의 인증 API가 활성화되지 않았습니다. Google Cloud 콘솔에서 'Identity Toolkit API'를 활성화해주세요.";
              break;
            default:
              errorMessage = `로그인에 실패했습니다. (${error.code})`;
              break;
          }
          authError.textContent = errorMessage;
          authError.classList.remove('hidden');
        };
        
        signupBtn.addEventListener('click', async () => {
          authError.classList.add('hidden');
          try {
            await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
          } catch (error) {
            handleAuthError(error);
          }
        });
        
        loginBtn.addEventListener('click', async () => {
          authError.classList.add('hidden');
          try {
            await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
          } catch (error) {
            handleAuthError(error);
          }
        });
        
        googleLoginBtn.addEventListener('click', async () => {
          authError.classList.add('hidden');
          const provider = new GoogleAuthProvider();
          try {
            await signInWithPopup(auth, provider);
          } catch (error) {
            handleAuthError(error);
          }
        });
        
        logoutBtn.addEventListener('click', () => signOut(auth));
        
        // -------------------------
        // 뷰 전환 관련 처리
        // -------------------------
        const switchView = (view) => {
          const targetView = view || 'dashboard';
          dashboardView.classList.toggle('hidden', targetView !== 'dashboard');
          generatorView.classList.toggle('hidden', targetView !== 'generator');
          navDashboard.classList.toggle('active', targetView === 'dashboard');
          navGenerator.classList.toggle('active', targetView === 'generator');
          window.location.hash = targetView;
          if (targetView === 'dashboard') {
            loadAndDisplayPlans();
          }
        };
        
        navDashboard.addEventListener('click', (e) => {
          e.preventDefault();
          switchView('dashboard');
        });
        navGenerator.addEventListener('click', (e) => {
          e.preventDefault();
          switchView('generator');
        });
        goToGeneratorBtn.addEventListener('click', () => switchView('generator'));
        
        // -------------------------
        // 통계 차트 렌더링
        // -------------------------
        const updateStatsChart = (plans) => {
          const statsCanvas = document.getElementById('statsChart');
          const chartContainer = document.getElementById('stats-chart-container');
          const ctx = statsCanvas.getContext('2d');
        
          if (statsChartInstance) {
            statsChartInstance.destroy();
            statsChartInstance = null;
          }
      
          const existingMessage = chartContainer.querySelector('.no-data-message');
          if (existingMessage) existingMessage.remove();
          statsCanvas.style.display = 'block';
      
          if (!plans || plans.length === 0) {
            statsCanvas.style.display = 'none';
            const noDataMessage = document.createElement('div');
            noDataMessage.className = 'no-data-message text-center text-gray-500 flex items-center justify-center h-full';
            noDataMessage.textContent = '생성된 계획서 없음';
            chartContainer.appendChild(noDataMessage);
            return;
          }
      
          const standardTypes = [
            '학교폭력 예방 교육 계획',
            '진로 체험 활동 계획',
            '디지털 리터러시 교육 계획',
            '기초학력 향상 지원 계획',
            '다문화 교육 활동 계획'
          ];
          const stats = { 기타: 0 };
          standardTypes.forEach(t => stats[t] = 0);
      
          plans.forEach(plan => {
            if (standardTypes.includes(plan.planType)) {
              stats[plan.planType]++;
            } else {
              stats['기타']++;
            }
          });
      
          const chartData = Object.values(stats).filter(count => count > 0);
          const chartLabels = Object.keys(stats).filter(type => stats[type] > 0);
      
          const shortLabels = chartLabels.map(label => {
            if (label === '기타') return '기타';
            return label.split(' ')[0];
          });
      
          statsChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: shortLabels,
              datasets: [{
                label: '계획서 종류',
                data: chartData,
                backgroundColor: ['#7A9D54', '#A8C292', '#E0A75E', '#F1DDBF', '#D4A5A5', '#8B9A46'],
                hoverOffset: 4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: { padding: 15, font: { family: "'Noto Sans KR', sans-serif" } }
                }
              }
            }
          });
        };
        
        // -------------------------
        // Firestore 로드 및 UI 렌더링
        // -------------------------
        const loadAndDisplayPlans = async () => {
          const user = auth.currentUser;
          if (!user) return;
        
          const plansCollectionRef = collection(db, "users", user.uid, "plans");
          const q = query(plansCollectionRef);
        
          try {
            const querySnapshot = await getDocs(q);
            const plans = [];
            querySnapshot.forEach(doc => {
              plans.push({ id: doc.id, ...doc.data() });
            });
        
            plans.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
        
            updateStatsChart(plans);
        
            recentPlansList.innerHTML = '';
            if (plans.length === 0) {
              recentPlansList.innerHTML = `<p class="text-gray-500 text-center py-4">아직 생성된 계획서가 없습니다.</p>`;
              return;
            }
        
            const recent5Plans = plans.slice(0, 5);
            recent5Plans.forEach(plan => {
              const planElement = document.createElement('div');
              planElement.className = 'p-4 border rounded-md hover:bg-gray-50 transition-colors flex justify-between items-center';
              planElement.innerHTML = `
                <div>
                  <p class="font-semibold">${plan.title || '(제목없음)'}</p>
                  <p class="text-sm text-gray-500">생성일: ${plan.createdAt ? new Date(plan.createdAt.toDate()).toLocaleDateString() : '-'}</p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="view-plan-btn text-sm font-medium text-blue-600 hover:underline" data-id="${plan.id}">보기</button>
                  <button class="delete-plan-btn text-sm font-medium text-red-600 hover:underline" data-id="${plan.id}">삭제</button>
                </div>
              `;
              recentPlansList.appendChild(planElement);
            });
        
            // ‘보기’ 버튼 이벤트 추가
            document.querySelectorAll('.view-plan-btn').forEach(button => {
              button.onclick = async e => {
                const user = auth.currentUser;
                if (!user) return;
                const id = e.target.dataset.id;
                try {
                  const docRef = doc(db, "users", user.uid, "plans", id);
                  const docSnap = await getDoc(docRef);
                  if (docSnap.exists()) {
                    const plan = docSnap.data();
                    switchView('generator');
                    displayContent(plan.rawContent, plan.title);
                    outputPanel.scrollIntoView({ behavior: 'smooth' });
                  } else {
                    alert('계획서를 불러오지 못했습니다.');
                  }
                } catch (error) {
                  console.error('Error loading plan:', error);
                  alert('계획서 불러오기 중 오류가 발생했습니다.');
                }
              };
            });
        
            // ‘삭제’ 버튼 이벤트 추가
            document.querySelectorAll('.delete-plan-btn').forEach(button => {
              button.onclick = async e => {
                const user = auth.currentUser;
                if (!user) return;
                if (!confirm('해당 계획서를 삭제하시겠습니까?')) return;
                const id = e.target.dataset.id;
                try {
                  await deleteDoc(doc(db, "users", user.uid, "plans", id));
                  await loadAndDisplayPlans();
                } catch (error) {
                  console.error('Error deleting plan:', error);
                  alert('계획서 삭제 중 오류가 발생했습니다.');
                }
              };
            });
        
          } catch (error) {
            console.error("Error loading plans:", error);
            recentPlansList.innerHTML = `<p class="text-red-500 text-center py-4">계획서 불러오기 실패: ${error.message}</p>`;
            updateStatsChart([]);
          }
        };
        
        // -------------------------
        // 계획서 조건 셀렉트 박스 초기화
        // -------------------------
        const populateSelects = () => {
          const schoolLevels = ['초등학교', '중학교', '고등학교'];
          const planTypes = [
            '학교폭력 예방 교육 계획',
            '진로 체험 활동 계획',
            '디지털 리터러시 교육 계획',
            '기초학력 향상 지원 계획',
            '다문화 교육 활동 계획',
            '직접 입력'
          ];
        
          schoolLevelSelect.innerHTML = schoolLevels.map(level => `<option value="${level}">${level}</option>`).join('');
          planTypeSelect.innerHTML = planTypes.map(type => `<option value="${type === '직접 입력' ? 'custom' : type}">${type}</option>`).join('');
        };
        
        planTypeSelect.addEventListener('change', () => {
          customPlanTypeWrapper.classList.toggle('hidden', planTypeSelect.value !== 'custom');
        });
        
        // -------------------------
        // AI 운영계획서 생성 (백엔드 호출)
        // -------------------------
        form.addEventListener('submit', async e => {
          e.preventDefault();
          const user = auth.currentUser;
          if (!user) {
            formError.textContent = '로그인 상태가 아닙니다. 다시 로그인해주세요.';
            formError.classList.remove('hidden');
            return;
          }
          formError.classList.add('hidden');
      
          let planType = planTypeSelect.value;
          if (planType === 'custom') {
            planType = customPlanTypeInput.value.trim();
            if (!planType) {
              formError.textContent = '계획서 종류를 직접 입력해주세요.';
              formError.classList.remove('hidden');
              return;
            }
          }
      
          initialMessage.classList.add('hidden');
          generatedContentWrapper.classList.add('hidden');
          errorMessageDiv.classList.add('hidden');
          loadingIndicator.style.display = 'flex';
          generateBtn.disabled = true;
          generateBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span class="ml-2">생성 중...</span>`;
      
          try {
            const keywords = document.getElementById('keywords').value || '없음';
            const includeBudget = includeBudgetCheckbox.checked;
        
            // Firebase ID 토큰 발급 (백엔드 인증용)
            const idToken = await user.getIdToken();
        
            const requestBody = {
              token: idToken,
              schoolLevel: schoolLevelSelect.value,
              planType,
              keywords,
              includeBudget,
            };
        
            // 반드시 배포 맞게 수정 필요
            const backendUrl = 'http://localhost:8080/generatePlan';
        
            const response = await fetch(backendUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestBody),
            });
        
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || 'AI 생성에 실패했습니다.');
            }
        
            const data = await response.json();
            const rawText = data.planText;
        
            const finalTitle = displayContent(rawText, planType);
        
            // Firestore 저장은 백엔드에서 하므로 클라이언트 쪽 추가 저장 코드 없음
        
            outputPanel.scrollIntoView({ behavior: 'smooth' });
        
            // 생성 후 목록 새로고침
            loadAndDisplayPlans();
        
          } catch (error) {
            console.error('AI 생성 오류:', error);
            errorMessageDiv.classList.remove('hidden');
            errorDetails.textContent = error.message || '알 수 없는 오류가 발생했습니다.';
          } finally {
            loadingIndicator.style.display = 'none';
            generateBtn.disabled = false;
            generateBtn.innerHTML = `<span>AI 운영계획서 생성</span>`;
          }
        });
        
        // -------------------------
        // AI 결과 내용 출력 함수
        // -------------------------
        function displayContent(rawText, defaultTitle) {
          const lines = rawText.split('\n');
          let html = '';
          let title = defaultTitle;
          let inTable = false;
        
          lines.forEach(line => {
            line = line.trim();
            if (line.startsWith('TITLE:')) {
              title = line.replace('TITLE:', '').trim();
              return;
            }
            if (inTable && !line.includes('|')) {
              html += '</tbody></table>';
              inTable = false;
            }
            if (line.startsWith('### ')) {
              html += `<h2>${line.replace('### ', '')}</h2>`;
            } else if (line.startsWith('* ')) {
              html += `<ul><li>${line.replace('* ', '')}</li></ul>`;
            } else if (line.includes('|')) {
              if (!inTable) {
                html += '<table class="w-full border-collapse"><thead><tr class="bg-gray-100">';
                const headers = line.split('|').map(h => h.trim()).filter(Boolean);
                headers.forEach(header => html += `<th class="border p-2">${header}</th>`);
                html += '</tr></thead><tbody>';
                inTable = true;
              } else if (!line.includes('---')) {
                html += '<tr>';
                const cells = line.split('|').map(c => c.trim()).filter(Boolean);
                cells.forEach(cell => html += `<td class="border p-2">${cell}</td>`);
                html += '</tr>';
              }
            } else if (line) {
              html += `<p>${line}</p>`;
            }
          });
      
          if (inTable) {
            html += '</tbody></table>';
          }
      
          planTitle.textContent = title;
          generatedContentDiv.innerHTML = html.replace(/<\/ul>\s*<ul>/g, '');
          generatedContentWrapper.classList.remove('hidden');
          initialMessage.classList.add('hidden');
          return title;
        }
        
        // -------------------------
        // 결과 복사 기능
        // -------------------------
        copyBtn.addEventListener('click', async () => {
          const htmlContent = generatedContentDiv.innerHTML;
        
          try {
            if (navigator.clipboard && window.ClipboardItem) {
              await navigator.clipboard.write([
                new ClipboardItem({ 'text/html': new Blob([htmlContent], { type: 'text/html' }) })
              ]);
            } else {
              const textArea = document.createElement('textarea');
              textArea.value = htmlContent;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
            }
            copyBtn.textContent = '복사 완료!';
          } catch (err) {
            console.error('클립보드 복사 실패:', err);
            copyBtn.textContent = '복사 실패';
          }
          setTimeout(() => { copyBtn.textContent = '본문 복사'; }, 2000);
        });
        
        // -------------------------
        // 초기화
        // -------------------------
        populateSelects();

    </script>
</body>
</html>
